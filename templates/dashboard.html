{% extends "base.html" %}

{% block content %}
<div class="board-container">
  <div class="form-card" style="text-align: left;">
    <!-- å¤´éƒ¨ä¿¡æ¯ -->
    <div style="text-align: center; margin-bottom: 30px;">
      <div class="logo-badge" style="margin: 0 auto 16px;">
        ğŸ‘¤
      </div>
      <h2>ä»ªè¡¨ç›˜</h2>
      <p class="subtitle">ç®¡ç†ä½ çš„è´¦å·è®¾ç½®</p>
    </div>
    
    <!-- æ˜¾ç¤ºæ¶ˆæ¯ -->
    {% with messages = get_flashed_messages() %}
      {% for message in messages %}
        <p style="
          padding: 10px; 
          margin: 10px 0; 
          border-radius: 6px; 
          background-color: 
            {% if 'æˆåŠŸ' in message or 'å¥–åŠ±' in message %}#d4edda; color: #155724
            {% elif 'ä¸è¶³' in message or 'æ— æ•ˆ' in message or 'å¤±è´¥' in message %}#f8d7da; color: #721c24
            {% else %}#fff3cd; color: #856404
            {% endif %};
        ">
          {{ message }}
        </p>
      {% endfor %}
    {% endwith %}

    <!-- ç”¨æˆ·ä¿¡æ¯ -->
    <div style="margin-bottom: 30px;">
      <p><strong>UUID:</strong> {{ user.id }}</p>
      <p><strong>ç”¨æˆ·å:</strong> {{ user.username }}</p>
      <p>
        <strong>æ˜µç§°:</strong> 
        <span id="nickname-display" style="margin-right: 8px;">{{ user.nickname or 'æœªè®¾ç½®' }}</span>

        <!-- ç¼–è¾‘æŒ‰é’® -->
        <button type="button" 
                id="edit-nickname-btn" 
                class="btn btn-outline-secondary btn-sm"
                style="font-size: 0.875rem; padding: 0.25rem 0.5rem;">
          ç¼–è¾‘
        </button>

        <!-- ç¼–è¾‘è¡¨å•ï¼ˆé»˜è®¤éšè—ï¼‰ -->
        <form id="nickname-form" method="POST" action="{{ url_for('auth.auth_update_nickname') }}" style="display: none; margin-left: 2px; align-items: center; gap: 8px; flex-wrap: nowrap;">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <input type="text" 
                name="nickname" 
                value="{{ user.nickname or '' }}" 
                maxlength="16" 
                required
                style="padding: 0.375rem; font-size: 0.875rem; width: 120px; border: 1px solid #ddd; border-radius: 4px;">

          <button type="submit" class="btn btn-success btn-sm" style="font-size: 0.875rem; padding: 0.25rem 0.5rem;">ä¿å­˜</button>
          <button type="button" 
                  id="cancel-nickname-btn" 
                  class="btn btn-secondary btn-sm" 
                  style="font-size: 0.875rem; padding: 0.25rem 0.5rem;">å–æ¶ˆ</button>
        </form>
      </p>
      <p><strong>æ³¨å†Œæ—¶é—´:</strong> {{ user.created_at }}</p>
      <p><strong>ä¸Šæ¬¡ç™»å½•:</strong> {{ user.last_login or 'First time' }}</p>
    </div>

    <!-- ç®¡ç†å‘˜å…¥å£ -->
    {% if user.is_admin %}
    <div style="margin-bottom: 30px; padding: 20px; background-color: #f8f9fa; border-radius: 8px; border-left: 4px solid #dc3545;">
      <h3 style="color: #dc3545; margin-top: 0;">ç®¡ç†å‘˜åŠŸèƒ½</h3>
      <p>ä½ æ‹¥æœ‰ç®¡ç†å‘˜æƒé™ï¼Œå¯ä»¥ç®¡ç†ç”¨æˆ·è´¦æˆ·ã€‚</p>
      <a href="{{ url_for('admin.admin_panel') }}" class="btn btn-danger" style="background-color: #dc3545; border-color: #dc3545;">
        ğŸ‘® ç®¡ç†å‘˜é¢æ¿
      </a>
    </div>
    {% endif %}

    <!-- å®‰å…¨ä¿¡æ¯ -->
    <h3 style="color: var(--gray-dark); margin: 24px 0 12px 0; font-size: 1.3rem;">å®‰å…¨</h3>
    <p>å£°æœ›: 
      <span style="color: {% if reputation >= 50 %}#10b981; font-weight:600{% else %}var(--danger);{% endif %};">
        {{ reputation }}
      </span>
      {% if reputation == 0 and totp_enabled %}
        (ç™»å‡ºä½¿ç”¨2FAéªŒè¯å³å¯åŠ 10å£°æœ›)
      {% endif %}
    </p>
    <p>2FA: 
      <span style="color: {% if totp_enabled %}#10b981; font-weight:600{% else %}var(--danger);{% endif %};">
        {{ 'å·²è®¾ç½®' if totp_enabled else 'æœªè®¾ç½®' }}
      </span>
    </p>

    <!-- è®¾ç½® 2FA é“¾æ¥ -->
    <p style="margin: 16px 0;">
      <a href="{{ url_for('auth.setup_totp') }}" class="link-primary">
        {% if totp_enabled %}
            ä¿®æ”¹2FAè®¾ç½®
        {% else %}
            è®¾ç½®2FAéªŒè¯
        {% endif %}
      </a>
    </p>
    <p style="margin: 16px 0;">
      <a href="{{ url_for('main.tokens') }}" class="link-primary">
        ç®¡ç†æ¸¸æˆè®¿é—®ä»¤ç‰Œ
      </a>
    </p>

    <!-- ç”¨æˆ·éªŒè¯åŠŸèƒ½ -->
    <h3 style="color: var(--gray-dark); margin: 24px 0 12px 0; font-size: 1.3rem;">ç”¨æˆ·éªŒè¯</h3>

    {% if reputation >= 50 %}
      <p>ä½ çš„å£°æœ› â‰¥ 50ï¼Œå¯ä»¥éªŒè¯å…¶ä»–ç”¨æˆ·ã€‚è¢«ä½ éªŒè¯çš„ç”¨æˆ·å°†è·å¾— <strong>30 æˆ– 50</strong> å£°æœ›ï¼ˆå–å†³äºä½ çš„å£°æœ›æ°´å¹³ï¼‰ã€‚</p>

      <form method="POST" action="{{ url_for('main.endorse_user') }}" style="margin: 16px 0; display: flex; gap: 10px;">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <input 
          type="text" 
          name="endorsee_id" 
          placeholder="è¾“å…¥å¯¹æ–¹çš„UUID" 
          required 
          style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;"
          maxlength="36"
        >
        <button type="submit" style="
          background-color: #28a745; 
          color: white; 
          border: none; 
          padding: 10px 16px; 
          border-radius: 6px; 
          font-size: 14px; 
          cursor: pointer;">
          éªŒè¯
        </button>
      </form>
    {% else %}
      <p style="color: #6c757d;">å£°æœ›éœ€è¾¾åˆ° <strong>50</strong> æ‰èƒ½éªŒè¯ä»–äººã€‚</p>
      <p style="font-size: 0.9rem; color: #888;">é€šè¿‡ç»‘å®š GitHubã€è®¾ç½® 2FAã€æ´»è·ƒå‚ä¸ç­‰æ–¹å¼æå‡å£°æœ›ã€‚</p>
    {% endif %}

    <!-- GitHub ç»‘å®šåŒºåŸŸ -->
    <h3 style="color: var(--gray-dark); margin: 24px 0 12px 0; font-size: 1.3rem;">ç¬¬ä¸‰æ–¹è´¦å·</h3>
    {% if github %}
      <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
        <img 
          src="{{ github.avatar_url }}?s=64" 
          alt="GitHub å¤´åƒ" 
          style="width: 48px; height: 48px; border-radius: 50%; border: 2px solid #e1e4e8;"
        >
        <div>
          <p style="margin: 0; font-weight: 600;">å·²ç»‘å®š GitHub è´¦å·</p>
          <p style="margin: 0; color: #555; font-size: 0.9rem;">@{{ github.github_login }}</p>
        </div>
      </div>
    {% else %}
      <p>å°šæœªç»‘å®š GitHub è´¦å·ã€‚</p>
      <p style="margin: 16px 0;">
        <a href="{{ url_for('github.github_login') }}" class="btn btn-secondary btn-block">
          ğŸ”— ç»‘å®š GitHub è´¦å·
        </a>
      </p>
    {% endif %}

    <!-- ç™»å‡ºæŒ‰é’® -->
    <a href="{{ url_for('main.logout') }}" class="btn btn-primary btn-block">ç™»å‡º</a>
  </div>
</div>
{% endblock %}
{% block scripts %}
{{ super() }}
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const editBtn = document.getElementById('edit-nickname-btn');
    const cancelBtn = document.getElementById('cancel-nickname-btn');
    const displaySpan = document.getElementById('nickname-display');
    const form = document.getElementById('nickname-form');

    // ç‚¹å‡»â€œç¼–è¾‘â€æŒ‰é’®
    editBtn.addEventListener('click', function () {
      form.style.display = 'inline-flex';
      displaySpan.style.display = 'none';
      editBtn.style.display = 'none';
    });

    // ç‚¹å‡»â€œå–æ¶ˆâ€æŒ‰é’®
    cancelBtn.addEventListener('click', function () {
      form.style.display = 'none';
      displaySpan.style.display = 'inline';
      editBtn.style.display = 'inline';
    });
  });
</script>
{% endblock %}