{% extends "base.html" %}

{% block content %}
<div class="board-container">
  <div class="form-card" style="text-align: left; padding: 40px;">
    <!-- å¤´éƒ¨ä¿¡æ¯ -->
    <div style="text-align: center; margin-bottom: 30px;">
      <div class="logo-badge" style="margin: 0 auto 16px;">
        ğŸ‘®
      </div>
      <h2>ç®¡ç†å‘˜é¢æ¿</h2>
      <p class="subtitle">ç®¡ç†ç”¨æˆ·è´¦æˆ·</p>
    </div>
    <p>
      <a href="{{ url_for('admin.whitelist_management') }}" class="btn btn-outline">
        ğŸ” ç®¡ç† API ç™½åå•
      </a>
    </p>

    
    {% with messages = get_flashed_messages() %}
        {% if messages %}
            <ul class="flashes">
                {% for message in messages %}
                    <li>{{ message }}</li>
                {% endfor %}
            </ul>
        {% endif %}
    {% endwith %}

    <!-- æœç´¢è¡¨å• -->
    <div style="margin-bottom: 20px;">
      <form method="GET" style="display: flex; gap: 10px;">
        <input 
          type="text" 
          name="search" 
          placeholder="æœç´¢ç”¨æˆ·åã€æ˜µç§°æˆ–ID..." 
          value="{{ search_query or '' }}"
          style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 4px;"
        >
        <button type="submit" class="btn btn-primary" style="background-color: #007bff; border-color: #007bff; padding: 10px 20px;">
          æœç´¢
        </button>
      </form>
    </div>

    <!-- ç»Ÿè®¡ä¿¡æ¯ -->
    <div style="margin-bottom: 20px; padding: 15px; background-color: #f8f9fa; border-radius: 5px; display: flex; gap: 20px; flex-wrap: wrap;">
      <p style="margin: 0;"><strong>æ€»ç”¨æˆ·æ•°:</strong> {{ total_users }}</p>
      <p style="margin: 0;"><strong>å½“å‰é¡µé¢:</strong> {{ current_page }} / {{ total_pages }}</p>
    </div>

    <!-- ç”¨æˆ·åˆ—è¡¨è¡¨æ ¼ -->
    <div style="overflow-x: auto; margin-bottom: 20px;">
      <table style="width: 100%; border-collapse: collapse;">
        <thead>
          <tr style="background-color: #f8f9fa;">
            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #dee2e6; min-width: 60px;">ID</th>
            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #dee2e6; min-width: 120px;">ç”¨æˆ·å</th>
            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #dee2e6; min-width: 120px;">æ˜µç§°</th>
            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #dee2e6; min-width: 80px;">å£°æœ›</th>
            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #dee2e6; min-width: 80px;">2FA</th>
            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #dee2e6; min-width: 80px;">ç®¡ç†å‘˜</th>
            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #dee2e6; min-width: 100px;">GitHub</th>
            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #dee2e6; min-width: 140px;">æ³¨å†Œæ—¶é—´</th>
            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #dee2e6; min-width: 140px;">æœ€åç™»å½•</th>
            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #dee2e6; min-width: 120px;">æ“ä½œ</th>
          </tr>
        </thead>
        <tbody>
          {% for user in users %}
          <tr style="border-bottom: 1px solid #dee2e6; transition: background-color 0.2s; {% if user.is_banned %}background-color: #ffebee;{% endif %}">
            <td style="padding: 12px;">{{ user.id }}</td>
            <td style="padding: 12px;">{{ user.username }}</td>
            <td style="padding: 12px;">{{ user.nickname }}</td>
            <td style="padding: 12px;">
              <span style="color: {% if (user.reputation_score or 0) >= 50 %}#10b981; font-weight:600{% elif (user.reputation_score or 0) > 0 %}#f59e0b; font-weight:600{% else %}#ef4444; font-weight:600{% endif %};">
                {{ user.reputation_score or 0 }}
              </span>
            </td>
            <td style="padding: 12px;">
              {% if user.is_2fa_enabled %}
                <span style="background-color: #28a745; color: white; padding: 2px 6px; border-radius: 4px; font-size: 12px;">å·²å¯ç”¨</span>
              {% else %}
                <span style="background-color: #6c757d; color: white; padding: 2px 6px; border-radius: 4px; font-size: 12px;">æœªå¯ç”¨</span>
              {% endif %}
            </td>
            <td style="padding: 12px;">
              {% if user.is_admin %}
                <span style="background-color: #dc3545; color: white; padding: 2px 6px; border-radius: 4px; font-size: 12px;">æ˜¯</span>
              {% else %}
                å¦
              {% endif %}
            </td>
            <td style="padding: 12px;">
              {% if user.github_login %}
                <span style="background-color: #24292e; color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px;">{{ user.github_login }}</span>
              {% else %}
                æ— 
              {% endif %}
            </td>
            <td style="padding: 12px;">{{ user.created_at.strftime('%Y-%m-%d %H:%M') if user.created_at else 'N/A' }}</td>
            <td style="padding: 12px;">{{ user.last_login.strftime('%Y-%m-%d %H:%M') if user.last_login else 'ä»æœªç™»å½•' }}</td>
            <td style="padding: 12px;">
              <div style="display: flex; flex-direction: column; gap: 8px;">
                {% if user.is_banned %}
                  <!-- ç”¨æˆ·è¢«å°ç¦ï¼Œæ˜¾ç¤ºæ’¤é”€å°ç¦æŒ‰é’® -->
                  <form method="POST" action="{{ url_for('admin.admin_unban_user', user_id=user.id) }}" style="display: inline;">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button type="submit" class="btn btn-success" style="background-color: #28a745; border-color: #28a745; padding: 6px 12px; font-size: 12px; margin: 0;" onclick="return confirm('ç¡®å®šè¦æ’¤é”€å°ç¦æ­¤ç”¨æˆ·å—ï¼Ÿæ­¤æ“ä½œå°†æ¢å¤ç”¨æˆ·å£°æœ›åˆ°åŸºç¡€åˆ†æ•°ï¼ˆ50åˆ†ï¼‰ã€‚');">
                      æ’¤é”€å°ç¦
                    </button>
                  </form>
                {% else %}
                  <!-- ç”¨æˆ·æœªè¢«å°ç¦ï¼Œæ˜¾ç¤ºå°ç¦æŒ‰é’® -->
                  <form method="POST" action="{{ url_for('admin.admin_ban_user', user_id=user.id) }}" style="display: inline;">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button type="submit" class="btn btn-danger" style="background-color: #dc3545; border-color: #dc3545; padding: 6px 12px; font-size: 12px; margin: 0;" onclick="return confirm('ç¡®å®šè¦å°ç¦æ­¤ç”¨æˆ·å—ï¼Ÿæ­¤æ“ä½œå°†æŠŠç”¨æˆ·å£°æœ›é™ä¸º0å¹¶è§¦å‘ç›¸å…³å¤„ç†ã€‚');">
                      å°ç¦
                    </button>
                  </form>
                {% endif %}
                
                <form method="POST" action="{{ url_for('admin.admin_toggle_admin', user_id=user.id) }}" style="display: inline;">
                  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                  <button type="submit" class="btn btn-secondary" style="background-color: #6c757d; border-color: #6c757d; padding: 6px 12px; font-size: 12px; margin: 0;">
                    {% if user.is_admin %}æ’¤é”€ç®¡ç†{% else %}æˆäºˆç®¡ç†{% endif %}
                  </button>
                </form>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- åˆ†é¡µ -->
    {% if total_pages > 1 %}
    <div class="pagination">
      <!-- é¦–é¡µ -->
      {% if current_page > 1 %}
        <a href="{{ url_for('admin.admin_panel', page=1, search=search_query) }}" class="page-link">é¦–é¡µ</a>
      {% else %}
        <span class="page-disabled">é¦–é¡µ</span>
      {% endif %}

      <!-- ä¸Šä¸€é¡µ -->
      {% if current_page > 1 %}
        <a href="{{ url_for('admin.admin_panel', page=current_page-1, search=search_query) }}" class="page-link">â†</a>
      {% else %}
        <span class="page-disabled">â†</span>
      {% endif %}

      <!-- é¡µç é€»è¾‘ -->
      {% set delta = 2 %}
      {% set left = current_page - delta %}
      {% set right = current_page + delta %}

      <!-- ç¬¬ä¸€é¡µ -->
      {% if current_page > 3 %}
        <a href="{{ url_for('admin.admin_panel', page=1, search=search_query) }}" class="page-link">1</a>
        {% if current_page > 4 %}
          <span class="page-ellipsis">â‹¯</span>
        {% endif %}
      {% endif %}

      <!-- ä¸­é—´é¡µç  -->
      {% for num in range(1, total_pages + 1) %}
        {% if num == current_page %}
          <span class="page-current">{{ num }}</span>
        {% elif (num <= 3 or num >= total_pages - 2) or (num >= left and num <= right) %}
          <a href="{{ url_for('admin.admin_panel', page=num, search=search_query) }}" class="page-link">{{ num }}</a>
        {% endif %}
      {% endfor %}

      <!-- æœ€åä¸€é¡µ -->
      {% if current_page < total_pages - 2 %}
        {% if current_page < total_pages - 3 %}
          <span class="page-ellipsis">â‹¯</span>
        {% endif %}
        <a href="{{ url_for('admin.admin_panel', page=total_pages, search=search_query) }}" class="page-link">{{ total_pages }}</a>
      {% endif %}

      <!-- ä¸‹ä¸€é¡µ -->
      {% if current_page < total_pages %}
        <a href="{{ url_for('admin.admin_panel', page=current_page+1, search=search_query) }}" class="page-link">â†’</a>
      {% else %}
        <span class="page-disabled">â†’</span>
      {% endif %}

      <!-- æœ«é¡µ -->
      {% if current_page < total_pages %}
        <a href="{{ url_for('admin.admin_panel', page=total_pages, search=search_query) }}" class="page-link">æœ«é¡µ</a>
      {% else %}
        <span class="page-disabled">æœ«é¡µ</span>
      {% endif %}
    </div>
    {% endif %}

    <!-- è¿”å›æŒ‰é’® -->
    <div style="margin-top: 30px; text-align: center;">
      <a href="{{ url_for('main.dashboard') }}" class="btn btn-secondary" style="padding: 12px 24px; display: inline-block; width: auto;">
        è¿”å›ä»ªè¡¨ç›˜
      </a>
    </div>
  </div>
</div>
{% endblock %}
